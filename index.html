<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRATAMENTO PLANILHA ITENS | PERFECTA</title>
  <!-- Biblioteca PapaParse para ler CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Fonte Montserrat (moderna) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- Cores atualizadas (vermelho no lugar do azul) --- */
    :root {
      --vermelho: #e74c3c;
      --vermelho-escuro: #c0392b;
      --cinza-escuro: #2c3e50;
      --cinza-claro: #ecf0f1;
      --branco: #ffffff;
      --sombra: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* --- Reset e estilos gerais (sem alterar funcionalidade) --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--cinza-claro);
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    /* --- Cabeçalho modernizado (mesma estrutura) --- */
    .main-header {
      background-color: var(--branco);
      padding: 15px 0;
      box-shadow: var(--sombra);
      margin-bottom: 30px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--cinza-escuro);
      margin: 0;
      text-transform: uppercase;
    }

    .logo {
      height: 50px;
    }

    /* --- Barra superior (mesmos IDs e classes) --- */
    .top-bar {
      max-width: 1200px;
      background: var(--branco);
      margin: 0 auto 30px auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--sombra);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .file-group, .btn-group, .update-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* --- Input de arquivo (mesmo funcionamento) --- */
    .file-group input[type="file"] {
      min-width: 200px;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: var(--branco);
      cursor: pointer;
      font-size: 14px;
    }

    .file-group input[type="file"]::-webkit-file-upload-button {
      visibility: hidden;
    }

    .file-group input[type="file"]::before {
      content: 'Escolher arquivo';
      display: inline-block;
      background: var(--vermelho);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      transition: background 0.3s;
    }

    .file-group input[type="file"]:hover::before {
      background: var(--vermelho-escuro);
    }

    /* --- Botões (mesma função, novo visual) --- */
    button {
      background: var(--cinza-escuro);
      color: var(--branco);
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #1a252f;
    }

    /* --- Container da tabela (mesma estrutura) --- */
    .container {
      max-width: 1200px;
      background: var(--branco);
      padding: 25px;
      margin: 0 auto 30px auto;
      border-radius: 8px;
      box-shadow: var(--sombra);
    }

    /* --- Tabelas (mesmo ID e classes) --- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--sombra);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px 15px;
      text-align: center;
    }

    th {
      background-color: var(--cinza-escuro);
      color: var(--branco);
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    /* --- Resumos (mesma estrutura original) --- */
    .resumos-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .resumo-box {
      flex: 1 1 400px;
      max-width: 600px;
      background: var(--branco);
      padding: 25px;
      border-radius: 8px;
      box-shadow: var(--sombra);
      display: flex;
      flex-direction: column;
    }

    .btn-container {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    /* --- Responsividade (igual ao original) --- */
    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .file-group, .btn-group, .update-group {
        width: 100%;
        justify-content: center;
      }

      .resumo-box {
        flex: 1 1 100%;
      }
    }

    @media (max-width: 480px) {
      .main-header h1 {
        font-size: 1.4rem;
      }

      button {
        padding: 8px 12px;
      }

      th, td {
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho (mesma estrutura) -->
  <header class="main-header">
    <div class="header-content">
      <h1>TRATAMENTO PLANILHA DE ITENS | PERFECTA</h1>
      <img src="LOGO.png" alt="Logo Perfecta" class="logo">
    </div>
  </header>

  <!-- Barra superior (mesmos IDs e classes) -->
  <div class="top-bar">
    <div class="file-group">
      <input type="file" id="csvFile" accept=".csv,.txt">
    </div>
    <div class="btn-group">
      <button onclick="exportCSV()">Exportar CSV (Planilha 1)</button>
      <button onclick="exportXLS()">Exportar XLS (Planilha 1)</button>
      <button onclick="copyProcessedTable()">Copiar Planilha 1 (para Notion)</button>
    </div>
    <div class="update-group">
      <label for="col9Color" style="white-space:nowrap;">COR:</label>
      <input type="text" id="col9Color" placeholder="Ex.: peltre">
      <button onclick="updateCol9()">Confirmar</button>
    </div>
  </div>

  <!-- Container da tabela (mesma estrutura) -->
  <div class="container">
    <h2>TABELA PROCESSADA</h2>
    <table id="resultTable">
      <thead>
        <tr>
          <th>TIPO</th>
          <th>ITENS</th>
          <th>DESCRIÇÃO</th>
          <th>AMBIENTE</th>
          <th>COR</th>
          <th>PRODUTO</th>
          <th>CATEGORIA</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão preenchidos dinamicamente -->
      </tbody>
    </table>
  </div>

  <!-- Resumos (mesma estrutura) -->
  <div class="resumos-container">
    <div class="resumo-box">
      <h2>TOTAL PRODUTO</h2>
      <div class="resumo-table-container">
        <table id="summaryTable">
          <thead>
            <tr>
              <th>PRODUTO</th>
              <th>QUANTIDADE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="btn-container">
        <div class="btn-group">
          <button onclick="exportCSVSummary()">Exportar CSV</button>
          <button onclick="exportXLSSummary()">Exportar XLS</button>
          <button onclick="copySummaryTable()">Copiar (para Notion)</button>
        </div>
      </div>
    </div>

    <div class="resumo-box">
      <h2>TOTAL CATEGORIA</h2>
      <div class="resumo-table-container">
        <table id="summaryTable2">
          <thead>
            <tr>
              <th>CATEGORIA</th>
              <th>QUANTIDADE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="btn-container">
        <div class="btn-group">
          <button onclick="exportCSVSummary2()">Exportar CSV</button>
          <button onclick="exportXLSSummary2()">Exportar XLS</button>
          <button onclick="copySummaryTable2()">Copiar (para Notion)</button>
        </div>
      </div>
    </div>
  </div>

  <!--  ==== JAVASCRIPT ORIGINAL (INTACTO) ==== -->
  <script>
    // Array com os dados processados (cada linha é um array)
    let processedData = [];
    // Variável global para guardar o último valor de cor atualizado
    let lastUpdatedColor = null;
    // Contagens para os resumos
    const summaryCounts = {};   // Para PRODUTO (utilizando getCodigo)
    const summaryCounts2 = {};  // Para CATEGORIA (utilizando getCodigo2)
    let totalItens = 0;         // Soma dos valores da 8ª coluna do CSV

    // Função para determinar o PRODUTO (baseada na DESCRIÇÃO – COLUNA 4)
    function getCodigo(texto) {
      const str = texto.toLowerCase();
      if (str.includes("fixo")) {
        return "Fixo";
      } else if (str.includes("porta de correr") && str.includes("persiana")) {
        return "PCR Integrada";
      } else if (str.includes("janela de correr") && str.includes("persiana")) {
        return "JCR Integrada";
      } else if (str.includes("porta de correr")) {
        return "PCR";
      } else if (str.includes("janela de correr")) {
        return "JCR";
      } else if (str.includes("persiana")) {
        return "Integrada";
      } else if (str.includes("acm")) {
        return "ACM";
      } else if (str.includes("maxim-ar") || str.includes("maxim") || str.includes("max")) {
        return "Maxim-ar";
      } else if (str.includes("porta de giro")) {
        return "PGR";
      } else if (str.includes("oscilo") || str.includes("osc") || str.includes("abt")) {
        return "Oscilo";
      } else if (str.includes("pivotante")) {
        return "Pivotante";
      } else if (str.includes("brise")) {
        return "Brise";
      } else if (str.includes("ripado")) {
        return "Ripado";
      }
      return "";
    }

    // Função para determinar a CATEGORIA (baseada nos ITENS – COLUNA 3)
    function getCodigo2(texto) {
      const str = texto.toLowerCase();
      if (str.includes("gol")) {
        return "Aluminio";
      } else if (str.includes("rip")) {
        return "Ripado";
      } else if (str.includes("brise")) {
        return "Brise";
      } else if (str.includes("acm") || str.includes("layer")) {
        return "Layer";
      }
      return "PVC";
    }

    // Leitura do arquivo CSV/TXT
    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        complete: function(results) {
          processedData = [];
          // Zera as contagens
          for (let key in summaryCounts) { delete summaryCounts[key]; }
          for (let key in summaryCounts2) { delete summaryCounts2[key]; }
          totalItens = 0;

          // Processa cada linha do CSV
          results.data.forEach(function(row) {
            if (row.length >= 8 && row[0] && !isNaN(row[7])) {
              const tipo = row[0];
              const itens = row[2];
              const descricao = row[3];
              const ambiente = row[4];
              const cor = row[5] || lastUpdatedColor || "";
              const produto = getCodigo(descricao);
              const categoria = getCodigo2(itens);
              const quantidade = parseFloat(row[7]);

              // Adiciona aos dados processados
              processedData.push([tipo, itens, descricao, ambiente, cor, produto, categoria, quantidade]);

              // Atualiza contagem para resumo por produto
              if (produto) {
                summaryCounts[produto] = (summaryCounts[produto] || 0) + quantidade;
              }

              // Atualiza contagem para resumo por categoria
              if (categoria) {
                summaryCounts2[categoria] = (summaryCounts2[categoria] || 0) + quantidade;
              }

              // Soma ao total de itens
              totalItens += quantidade;
            }
          });

          // Atualiza a tabela principal
          updateResultTable();
          // Atualiza as tabelas de resumo
          updateSummaryTables();
        },
        error: function(error) {
          console.error("Erro ao processar arquivo:", error);
        }
      });
    });

    // Atualiza a tabela principal com os dados processados
    function updateResultTable() {
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';

      processedData.forEach(function(row) {
        const tr = document.createElement('tr');
        
        // Adiciona as células com os dados processados
        for (let i = 0; i < 7; i++) { // Apenas as 7 primeiras colunas (a 8ª é a quantidade)
          const td = document.createElement('td');
          td.textContent = row[i] || '';
          tr.appendChild(td);
        }
        
        tbody.appendChild(tr);
      });
    }

    // Atualiza as tabelas de resumo
    function updateSummaryTables() {
      updateSummaryTable('summaryTable', summaryCounts);
      updateSummaryTable('summaryTable2', summaryCounts2);
    }

    // Atualiza uma tabela de resumo específica
    function updateSummaryTable(tableId, data) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';

      // Ordena os itens por quantidade (decrescente)
      const sortedItems = Object.entries(data).sort((a, b) => b[1] - a[1]);

      sortedItems.forEach(function([item, quantidade]) {
        const tr = document.createElement('tr');
        
        const tdItem = document.createElement('td');
        tdItem.textContent = item;
        
        const tdQuantidade = document.createElement('td');
        tdQuantidade.textContent = quantidade;
        
        tr.appendChild(tdItem);
        tr.appendChild(tdQuantidade);
        tbody.appendChild(tr);
      });

      // Adiciona linha de total se for a tabela de produtos
      if (tableId === 'summaryTable') {
        const trTotal = document.createElement('tr');
        trTotal.style.fontWeight = 'bold';
        
        const tdTotalLabel = document.createElement('td');
        tdTotalLabel.textContent = 'TOTAL';
        
        const tdTotalValue = document.createElement('td');
        tdTotalValue.textContent = totalItens;
        
        trTotal.appendChild(tdTotalLabel);
        trTotal.appendChild(tdTotalValue);
        tbody.appendChild(trTotal);
      }
    }

    // Atualiza a coluna de cor (COLUNA 9) com o valor digitado
    function updateCol9() {
      const colorInput = document.getElementById('col9Color');
      const newColor = colorInput.value.trim();
      
      if (!newColor) {
        alert('Por favor, digite um valor para a cor.');
        return;
      }
      
      lastUpdatedColor = newColor;
      
      // Atualiza a cor em todos os dados processados onde a cor estava vazia
      processedData.forEach(function(row) {
        if (!row[4] || row[4] === lastUpdatedColor) {
          row[4] = newColor;
        }
      });
      
      // Atualiza a exibição da tabela
      updateResultTable();
    }

    // Exporta a tabela processada para CSV
    function exportCSV() {
      if (processedData.length === 0) {
        alert('Não há dados para exportar.');
        return;
      }
      
      // Cria cabeçalhos
      const headers = ['TIPO', 'ITENS', 'DESCRIÇÃO', 'AMBIENTE', 'COR', 'PRODUTO', 'CATEGORIA', 'QUANTIDADE'];
      const data = [headers, ...processedData];
      
      const csv = Papa.unparse(data);
      downloadFile(csv, 'planilha_processada.csv', 'text/csv;charset=utf-8;');
    }

    // Exporta a tabela processada para XLS
    function exportXLS() {
      if (processedData.length === 0) {
        alert('Não há dados para exportar.');
        return;
      }
      
      // Cria cabeçalhos
      const headers = ['TIPO', 'ITENS', 'DESCRIÇÃO', 'AMBIENTE', 'COR', 'PRODUTO', 'CATEGORIA', 'QUANTIDADE'];
      const data = [headers, ...processedData];
      
      let csv = Papa.unparse(data);
      
      // Converter CSV para XLS
      let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Planilha1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>';
      
      data.forEach(function(row) {
        html += '<tr>';
        row.forEach(function(cell) {
          html += '<td>' + (cell || '') + '</td>';
        });
        html += '</tr>';
      });
      
      html += '</table></body></html>';
      
      downloadFile(html, 'planilha_processada.xls', 'application/vnd.ms-excel');
    }

    // Copia a tabela processada para área de transferência (formato para Notion)
    function copyProcessedTable() {
      if (processedData.length === 0) {
        alert('Não há dados para copiar.');
        return;
      }
      
      let text = 'TIPO\tITENS\tDESCRIÇÃO\tAMBIENTE\tCOR\tPRODUTO\tCATEGORIA\tQUANTIDADE\n';
      
      processedData.forEach(function(row) {
        text += row.join('\t') + '\n';
      });
      
      navigator.clipboard.writeText(text).then(function() {
        alert('Dados copiados para a área de transferência no formato para Notion!');
      }, function() {
        alert('Erro ao copiar para a área de transferência. Por favor, tente novamente.');
      });
    }

    // Exporta a tabela de resumo (produto) para CSV
    function exportCSVSummary() {
      exportSummaryToCSV(summaryCounts, 'resumo_produto.csv');
    }

    // Exporta a tabela de resumo (produto) para XLS
    function exportXLSSummary() {
      exportSummaryToXLS(summaryCounts, 'resumo_produto.xls');
    }

    // Copia a tabela de resumo (produto) para área de transferência (formato para Notion)
    function copySummaryTable() {
      copySummaryToClipboard(summaryCounts, 'PRODUTO');
    }

    // Exporta a tabela de resumo (categoria) para CSV
    function exportCSVSummary2() {
      exportSummaryToCSV(summaryCounts2, 'resumo_categoria.csv');
    }

    // Exporta a tabela de resumo (categoria) para XLS
    function exportXLSSummary2() {
      exportSummaryToXLS(summaryCounts2, 'resumo_categoria.xls');
    }

    // Copia a tabela de resumo (categoria) para área de transferência (formato para Notion)
    function copySummaryTable2() {
      copySummaryToClipboard(summaryCounts2, 'CATEGORIA');
    }

    // Função auxiliar para exportar resumo para CSV
    function exportSummaryToCSV(data, filename) {
      if (Object.keys(data).length === 0) {
        alert('Não há dados para exportar.');
        return;
      }
      
      const headers = ['ITEM', 'QUANTIDADE'];
      const rows = Object.entries(data).map(([item, quantidade]) => [item, quantidade]);
      
      // Adiciona total se for o resumo de produtos
      if (filename.includes('produto')) {
        rows.push(['TOTAL', totalItens]);
      }
      
      const csv = Papa.unparse([headers, ...rows]);
      downloadFile(csv, filename, 'text/csv;charset=utf-8;');
    }

    // Função auxiliar para exportar resumo para XLS
    function exportSummaryToXLS(data, filename) {
      if (Object.keys(data).length === 0) {
        alert('Não há dados para exportar.');
        return;
      }
      
      const headers = ['ITEM', 'QUANTIDADE'];
      const rows = Object.entries(data).map(([item, quantidade]) => [item, quantidade]);
      
      // Adiciona total se for o resumo de produtos
      if (filename.includes('produto')) {
        rows.push(['TOTAL', totalItens]);
      }
      
      let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Planilha1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>';
      
      // Adiciona cabeçalhos
      html += '<tr><th>' + headers.join('</th><th>') + '</th></tr>';
      
      // Adiciona linhas de dados
      rows.forEach(function(row) {
        html += '<tr><td>' + row.join('</td><td>') + '</td></tr>';
      });
      
      html += '</table></body></html>';
      
      downloadFile(html, filename, 'application/vnd.ms-excel');
    }

    // Função auxiliar para copiar resumo para área de transferência
    function copySummaryToClipboard(data, type) {
      if (Object.keys(data).length === 0) {
        alert('Não há dados para copiar.');
        return;
      }
      
      let text = `${type}\tQUANTIDADE\n`;
      
      Object.entries(data).forEach(([item, quantidade]) => {
        text += `${item}\t${quantidade}\n`;
      });
      
      // Adiciona total se for o resumo de produtos
      if (type === 'PRODUTO') {
        text += `TOTAL\t${totalItens}\n`;
      }
      
      navigator.clipboard.writeText(text).then(function() {
        alert(`Resumo de ${type.toLowerCase()} copiado para a área de transferência no formato para Notion!`);
      }, function() {
        alert('Erro ao copiar para a área de transferência. Por favor, tente novamente.');
      });
    }

    // Função auxiliar para download de arquivo
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }
  </script>
</body>
</html>
